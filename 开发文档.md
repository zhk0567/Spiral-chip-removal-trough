# 螺旋排屑槽绘制接口开发文档

## 一、项目概述

### 1.1 项目目标
开发一个专门的接口（API），用于根据输入参数自动生成螺旋排屑槽的二维图形数据，并支持通过AutoCAD API进行图形优化。

### 1.2 应用领域
- **CAD/CAM**：计算机辅助设计与制造
- **机械工程**：刀具（钻头）设计
- **工业软件**：工程图形生成工具

### 1.3 核心功能
- 输入参数化设计（5个关键参数）
- 自动计算螺旋排屑槽几何数据
- 生成二维图形点集
- 可选集成AutoCAD API进行图形优化
- 图形数据输出供显示使用

---

## 二、需求分析

### 2.1 输入参数

| 参数名称 | 类型 | 单位 | 说明 | 取值范围 |
|---------|------|------|------|---------|
| 螺旋角 (spiralAngle) | double | 度 | 螺旋线与轴线的夹角 | 0° < angle < 90° |
| 钻头直径 (drillDiameter) | double | mm | 钻头的外径 | > 0 |
| 钻头总长 (totalLength) | double | mm | 钻头的总长度 | > 0 |
| 刀瓣宽度 (bladeWidth) | double | mm | 排屑槽的宽度 | > 0 |
| 刀瓣高度 (bladeHeight) | double | mm | 排屑槽的深度 | > 0 |

### 2.2 输出数据

#### 2.2.1 中心线点集
- **类型**：`std::vector<Point2D>`
- **说明**：螺旋排屑槽中心线的二维坐标点集合
- **用途**：定义螺旋槽的中心轨迹

#### 2.2.2 边界点对集合
- **类型**：`std::vector<std::pair<Point2D, Point2D>>`
- **说明**：螺旋槽左右边界的点对集合
  - `first`：左边界点
  - `second`：右边界点
- **用途**：定义螺旋槽的宽度边界

#### 2.2.3 刀具轮廓点集
- **类型**：`std::vector<Point2D>`
- **说明**：刀具外轮廓的二维坐标点集合（矩形轮廓）
- **用途**：显示刀具的整体形状

### 2.3 功能要求

1. **参数验证**
   - 检查所有输入参数的有效性
   - 验证参数之间的逻辑关系
   - 提供清晰的错误提示

2. **几何计算**
   - 准确计算螺旋展开图的数学关系
   - 生成足够密度的点集以保证图形平滑
   - 支持不同精度要求（可配置采样点数）

3. **AutoCAD集成**（可选）
   - 检测AutoCAD是否可用
   - 使用AutoCAD几何API优化点数据
   - 优雅降级：AutoCAD不可用时使用原始数据

4. **性能要求**
   - 计算响应时间 < 1秒（常规参数）
   - 内存占用合理
   - 支持实时参数调整

---

## 三、接口设计

### 3.1 核心接口类：`SpiralCalculator`

#### 3.1.1 计算螺旋槽中心线
```cpp
static std::vector<Point2D> CalculateSpiralGroove(
    double spiralAngle,        // 螺旋角（度）
    double drillDiameter,      // 钻头直径（mm）
    double totalLength,         // 钻头总长（mm）
    double bladeWidth,         // 刀瓣宽度（mm）
    double bladeHeight,        // 刀瓣高度（mm）
    int pointsPerRevolution = 100  // 每圈采样点数
);
```

**算法说明**：
- 将螺旋角转换为弧度
- 计算螺旋的螺距（pitch）：`pitch = circumference / tan(angle)`
- 计算总圈数：`totalRevolutions = totalLength / pitch`
- 生成展开图坐标：
  - X轴：沿钻头轴线的长度方向
  - Y轴：展开后的圆周方向
  - 公式：`y = (x / pitch) * circumference`

#### 3.1.2 计算边界点
```cpp
static std::vector<std::pair<Point2D, Point2D>> CalculateBoundaries(
    const std::vector<Point2D>& centerPoints,  // 中心线点集
    double bladeWidth                           // 刀瓣宽度（mm）
);
```

**算法说明**：
- 在展开图中，边界线平行于中心线
- 左边界：Y方向向上偏移 `+bladeWidth/2`
- 右边界：Y方向向下偏移 `-bladeWidth/2`

#### 3.1.3 计算刀具轮廓
```cpp
static std::vector<Point2D> CalculateToolOutline(
    double drillDiameter,  // 钻头直径（mm）
    double totalLength     // 钻头总长（mm）
);
```

**算法说明**：
- 生成矩形轮廓（展开图）
- 高度 = 圆周长度 = `2 * π * radius`
- 宽度 = 总长度

### 3.2 AutoCAD集成接口：`AutoCADDrawer`

#### 3.2.1 主接口：生成并优化图形数据
```cpp
static bool GenerateWithAutoCADAPI(
    std::vector<Point2D>& centerPoints,                    // 中心线（输入输出）
    std::vector<std::pair<Point2D, Point2D>>& boundaries,  // 边界（输入输出）
    std::vector<Point2D>& toolOutline                       // 轮廓（输入输出）
);
```

**功能流程**：
1. 检查AutoCAD是否可用
2. 如果可用，使用AutoCAD几何API优化点数据
3. 如果不可用，返回false（使用原始数据）

#### 3.2.2 辅助接口

**检查AutoCAD可用性**：
```cpp
static bool IsAutoCADAvailable();
```

**获取AutoCAD应用对象**：
```cpp
static bool GetAutoCADApp(void** ppApp);
```

**创建多段线并优化**：
```cpp
static bool CreatePolylineWithAutoCAD(
    const std::vector<Point2D>& input,
    std::vector<Point2D>& output
);
```

**创建螺旋线**（如果AutoCAD支持）：
```cpp
static bool CreateHelixWithAutoCAD(
    double spiralAngle,
    double drillDiameter,
    double totalLength,
    std::vector<Point2D>& outputPoints
);
```

---

## 四、实现步骤

### 4.1 第一阶段：核心计算接口

#### 任务清单
- [ ] **实现 `SpiralCalculator::CalculateSpiralGroove`**
  - 实现螺旋角到弧度的转换
  - 实现螺距计算
  - 实现总圈数计算
  - 实现展开图坐标生成
  - 添加参数验证和错误处理

- [ ] **实现 `SpiralCalculator::CalculateBoundaries`**
  - 实现边界点偏移计算
  - 确保边界点数量与中心线点数量一致

- [ ] **实现 `SpiralCalculator::CalculateToolOutline`**
  - 实现矩形轮廓生成
  - 确保轮廓闭合

- [ ] **单元测试**
  - 测试各种参数组合
  - 验证计算结果正确性
  - 测试边界情况（极值、异常值）

### 4.2 第二阶段：AutoCAD集成接口

#### 任务清单
- [ ] **实现COM初始化**
  - 初始化COM库（`CoInitialize`）
  - 处理COM错误

- [ ] **实现AutoCAD检测**
  - 使用`CLSIDFromProgID`获取AutoCAD CLSID
  - 使用`GetActiveObject`获取运行中的AutoCAD实例
  - 如果无运行实例，使用`CoCreateInstance`启动AutoCAD

- [ ] **实现AutoCAD API调用**
  - 通过IDispatch接口调用AutoCAD方法
  - 实现`AddPolyline`调用
  - 实现`AddSpline`调用（可选）
  - 实现`AddHelix`调用（如果支持）

- [ ] **实现数据优化**
  - 将点数据转换为AutoCAD坐标格式
  - 调用AutoCAD几何API
  - 从AutoCAD实体中提取优化后的点数据

- [ ] **错误处理**
  - 处理AutoCAD不可用的情况
  - 处理COM调用失败的情况
  - 实现优雅降级

### 4.3 第三阶段：接口封装和文档

#### 任务清单
- [ ] **接口文档**
  - 编写详细的API文档
  - 提供使用示例
  - 说明参数和返回值

- [ ] **错误处理完善**
  - 统一错误码定义
  - 提供错误信息接口
  - 记录错误日志

- [ ] **性能优化**
  - 优化计算算法
  - 减少内存分配
  - 提高计算速度

- [ ] **集成测试**
  - 测试完整流程
  - 测试AutoCAD集成
  - 测试异常情况处理

---

## 五、技术要点

### 5.1 数学计算

#### 关键公式
1. **螺距计算**：
   ```
   pitch = circumference / tan(螺旋角)
   circumference = 2 * π * radius
   ```

2. **展开图坐标**：
   ```
   x = 沿轴线的长度（0 到 totalLength）
   y = (x / pitch) * circumference
   ```

3. **边界偏移**：
   ```
   左边界：y_left = y_center + bladeWidth/2
   右边界：y_right = y_center - bladeWidth/2
   ```

### 5.2 COM编程

#### 关键步骤
1. **初始化COM**：
   ```cpp
   CoInitialize(NULL);
   ```

2. **获取AutoCAD对象**：
   ```cpp
   CLSID clsid;
   CLSIDFromProgID(L"AutoCAD.Application", &clsid);
   GetActiveObject(clsid, NULL, &pUnknown);
   ```

3. **调用AutoCAD方法**：
   ```cpp
   IDispatch* pDisp = ...;
   DISPID dispid;
   OLECHAR* methodName = L"AddPolyline";
   pDisp->GetIDsOfNames(IID_NULL, &methodName, 1, LOCALE_USER_DEFAULT, &dispid);
   pDisp->Invoke(dispid, IID_NULL, LOCALE_USER_DEFAULT, DISPATCH_METHOD, &params, ...);
   ```

### 5.3 数据结构

#### Point2D结构
```cpp
struct Point2D {
    double x;  // X坐标
    double y;  // Y坐标
};
```

#### 边界点对
```cpp
std::pair<Point2D, Point2D>
// first: 左边界点
// second: 右边界点
```

### 5.4 错误处理策略

1. **参数验证**：
   - 检查参数范围
   - 检查参数逻辑关系
   - 返回明确的错误信息

2. **计算错误**：
   - 检查除零情况
   - 检查NaN和Inf
   - 提供默认值或错误码

3. **AutoCAD错误**：
   - 检查COM初始化
   - 检查AutoCAD可用性
   - 优雅降级到原始数据

---

## 六、测试要求

### 6.1 单元测试

#### 测试用例1：基本功能测试
- **输入**：标准参数（螺旋角30°，直径10mm，长度50mm，宽度2mm，高度1mm）
- **预期**：生成有效的点集，边界正确，轮廓正确

#### 测试用例2：边界值测试
- **输入**：最小螺旋角（接近0°）
- **预期**：正确处理，不产生除零错误

#### 测试用例3：边界值测试
- **输入**：最大螺旋角（接近90°）
- **预期**：正确处理，不产生数值溢出

#### 测试用例4：异常值测试
- **输入**：无效参数（负数、零、过大值）
- **预期**：返回错误或使用默认值

### 6.2 集成测试

#### 测试用例1：完整流程测试
- **步骤**：
  1. 输入参数
  2. 调用计算接口
  3. 调用AutoCAD优化接口（如果可用）
  4. 验证输出数据
- **预期**：所有步骤成功完成

#### 测试用例2：AutoCAD不可用测试
- **步骤**：
  1. 关闭AutoCAD
  2. 调用接口
- **预期**：优雅降级，使用原始数据

### 6.3 性能测试

- **测试指标**：
  - 计算时间 < 1秒（1000个点）
  - 内存占用 < 10MB
  - CPU使用率 < 50%

---

## 七、交付物清单

### 7.1 源代码

- [x] `SpiralCalculator.h` - 计算接口头文件
- [x] `SpiralCalculator.cpp` - 计算接口实现
- [x] `AutoCADDrawer.h` - AutoCAD集成接口头文件
- [x] `AutoCADDrawer.cpp` - AutoCAD集成接口实现
- [x] `Point2D` 结构定义

### 7.2 文档

- [x] `README.md` - 项目说明
- [x] `开发文档.md` - 本文档
- [ ] `API参考文档.md` - 详细的API文档（待完善）
- [ ] `使用示例.md` - 代码使用示例（待完善）

### 7.3 测试

- [ ] 单元测试代码
- [ ] 集成测试代码
- [ ] 测试报告

### 7.4 构建配置

- [x] `CMakeLists.txt` - CMake构建配置
- [x] 资源文件（`.rc`文件）

---

## 八、开发时间估算

### 8.1 核心计算接口（已完成）
- **状态**：✅ 已完成
- **时间**：已投入

### 8.2 AutoCAD集成接口（部分完成）
- **状态**：🔄 部分完成
- **剩余工作**：
  - 完善COM调用实现：**2-3天**
  - 实现AutoCAD几何优化：**3-5天**
  - 错误处理和测试：**1-2天**
- **总计**：**6-10天**

### 8.3 文档和测试（待完成）
- **API文档**：**1-2天**
- **使用示例**：**1天**
- **单元测试**：**2-3天**
- **集成测试**：**1-2天**
- **总计**：**5-8天**

### 8.4 总体时间估算
- **已完成**：核心计算接口
- **进行中**：AutoCAD集成
- **待完成**：文档和测试
- **预计总时间**：**11-18天**

---

## 九、关键技术难点

### 9.1 螺旋展开图计算
- **难点**：理解螺旋在展开图中的数学关系
- **解决**：使用螺距和圆周长的关系，将3D螺旋投影到2D展开图

### 9.2 AutoCAD COM集成
- **难点**：COM接口调用复杂，错误处理困难
- **解决**：使用IDispatch动态调用，实现完善的错误处理

### 9.3 图形数据优化
- **难点**：AutoCAD没有直接的螺旋排屑槽API
- **解决**：使用AutoCAD的几何API（Polyline、Spline）进行间接优化

### 9.4 性能优化
- **难点**：大量点数据的计算和内存管理
- **解决**：合理设置采样点数，使用高效的数据结构

---

## 十、后续扩展方向

### 10.1 功能扩展
- [ ] 支持多螺旋槽（多个刀瓣）
- [ ] 支持变螺距螺旋
- [ ] 支持3D视图生成
- [ ] 支持导出DXF/DWG文件

### 10.2 接口扩展
- [ ] 提供C接口封装（供其他语言调用）
- [ ] 提供.NET封装
- [ ] 提供Python绑定

### 10.3 性能优化
- [ ] 多线程计算
- [ ] GPU加速计算
- [ ] 增量更新机制

---

## 十一、总结

### 11.1 当前状态
- ✅ 核心计算接口已实现
- 🔄 AutoCAD集成接口部分实现
- ⏳ 文档和测试待完善

### 11.2 下一步工作重点
1. **完善AutoCAD COM调用**：实现真正的AutoCAD API调用和数据优化
2. **完善错误处理**：统一错误码，提供清晰的错误信息
3. **编写测试代码**：确保接口的稳定性和正确性
4. **完善文档**：提供详细的API文档和使用示例

### 11.3 成功标准
- ✅ 接口能够正确计算螺旋排屑槽数据
- ✅ AutoCAD集成能够正常工作（如果AutoCAD可用）
- ✅ 代码质量高，错误处理完善
- ✅ 文档完整，易于使用和维护

